name: Deploy to Cloud Run

on:
  push:
    branches: [main]

jobs:
  # CI ゲート: lint + typecheck + test をパスしてからデプロイ
  ci-gate:
    name: CI Gate
    uses: ./.github/workflows/ci.yml

  # 変更検知: 対象サービスの判定
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    needs: ci-gate
    outputs:
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
      worker: ${{ steps.filter.outputs.worker }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/db/**'
              - 'packages/shared/**'
              - 'pnpm-lock.yaml'
            web:
              - 'apps/web/**'
              - 'packages/db/**'
              - 'packages/shared/**'
              - 'pnpm-lock.yaml'
            worker:
              - 'apps/worker/**'
              - 'packages/db/**'
              - 'packages/shared/**'
              - 'packages/ai/**'
              - 'pnpm-lock.yaml'

  # API サービスのデプロイ
  deploy-api:
    name: Deploy API
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service_name: hr-api
      app_name: api
      dockerfile_path: apps/api/Dockerfile
    secrets:
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}

  # Web サービスのデプロイ
  deploy-web:
    name: Deploy Web
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service_name: hr-web
      app_name: web
      dockerfile_path: apps/web/Dockerfile
    secrets:
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}

  # Worker サービスのデプロイ
  deploy-worker:
    name: Deploy Worker
    needs: detect-changes
    if: needs.detect-changes.outputs.worker == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service_name: hr-worker
      app_name: worker
      dockerfile_path: apps/worker/Dockerfile
    secrets:
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
